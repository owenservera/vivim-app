# VIVIM Data Flow Documentation

## Overview

This document describes the data flows in the VIVIM platform, from user interactions to data persistence and synchronization.

---

## 1. User Data Flow

### 1.1 Registration & Authentication Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     User Registration & Authentication                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  1. User initiates login                                                    │
│      │                                                                      │
│      ▼                                                                      │
│  2. Client redirects to Google OAuth                                        │
│      │                                                                      │
│      ▼                                                                      │
│  3. Google OAuth Challenge                                                  │
│      │                                                                      │
│      ▼                                                                      │
│  4. Google returns auth code                                                │
│      │                                                                      │
│      ▼                                                                      │
│  5. Server exchanges code for tokens                                        │
│      │                                                                      │
│      ▼                                                                      │
│  6. Server creates session + generates JWT                                   │
│      │                                                                      │
│      ▼                                                                      │
│  7. Server returns session cookie + JWT                                     │
│      │                                                                      │
│      ▼                                                                      │
│  8. Client stores auth state (Zustand + IndexedDB)                         │
│      │                                                                      │
│      ▼                                                                      │
│  9. Client establishes Socket.io connection                                │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Identity Creation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Identity Creation                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User Account ──► Generate DID ──► Create Key Pair ──► Store Keys          │
│       │                    │              │              │                    │
│       │                    ▼              ▼              ▼                    │
│       │              ┌─────────┐   ┌─────────┐   ┌─────────────┐            │
│       └─────────────►│ User    │◄──│ Crypto  │◄──│ Device      │            │
│                       │ Record  │   │ Service │   │ Keys Store │            │
│                       └────┬────┘   └─────────┘   └─────────────┘            │
│                            │                                                  │
│                            ▼                                                  │
│                       ┌─────────┐                                            │
│                       │ DID     │                                            │
│                       │ Document│                                            │
│                       └─────────┘                                            │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Content Capture Flow

### 2.1 AI Conversation Capture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     AI Conversation Capture Pipeline                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                    │
│  │   Browser   │────►│  Playwright │────►│  Extractor  │                    │
│  │ (User URL)  │     │  (Headless) │     │  (Parser)   │                    │
│  └─────────────┘     └─────────────┘     └──────┬──────┘                    │
│                                                  │                           │
│                                                  ▼                           │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                    │
│  │  Database   │◄────│  Validation │◄────│   Context   │                    │
│  │  (Prisma)  │     │   (Zod)    │     │  Assembler  │                    │
│  └─────────────┘     └─────────────┘     └─────────────┘                    │
│         │                                        │                           │
│         │                                        ▼                           │
│         │                                  ┌─────────────┐                    │
│         │                                  │    AI      │                    │
│         └─────────────────────────────────►│ Processing │                    │
│                                           └─────────────┘                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 Content Extraction Steps

```
1. URL Validation
   ├── Verify URL format
   ├── Check against blocked domains
   └── Rate limit check

2. Browser Automation (Playwright)
   ├── Launch headless browser
   ├── Navigate to URL
   ├── Wait for page load
   ├── Extract conversation content
   └── Handle pagination

3. Content Parsing
   ├── Parse messages (user/AI)
   ├── Extract code blocks
   ├── Extract images/media
   ├── Identify tool calls
   └── Generate content hash

4. Validation
   ├── Validate required fields
   ├── Check content size limits
   └── Sanitize content

5. Storage
   ├── Create Conversation record
   ├── Create Message records
   ├── Create ACU records
   └── Index for search
```

---

## 3. Memory & Context Flow

### 3.1 Memory Extraction Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Memory Extraction Pipeline                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Conversation ──► LLM Extraction ──► Memory Validation ──► Storage          │
│       │                  │                    │                 │           │
│       │                  ▼                    ▼                 ▼           │
│       │           ┌────────────┐        ┌────────────┐    ┌─────────┐       │
│       └──────────►│ Extraction │───────►│  Quality   │───►│Memory   │       │
│                   │  Prompt   │        │  Checks    │    │  Store  │       │
│                   └────────────┘        └────────────┘    └────┬────┘       │
│                                                                │            │
│                                                                ▼            │
│                                                         ┌─────────────┐    │
│                                                         │  Indexing   │    │
│                                                         │ (Embedding) │    │
│                                                         └─────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 3.2 Context Compilation Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       Context Compilation Pipeline                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User Query ──► Query Analysis ──► Retrieval Plan ──► Execution ──► Output │
│      │             │               │              │              │           │
│      │             ▼               ▼              ▼              ▼           │
│      │      ┌────────────┐   ┌────────────┐ ┌─────────┐   ┌─────────┐       │
│      └─────►│  Intent    │──►│  Context   │►│  Data   │──►│ Compiled │       │
│              │  Detection │   │   Budget   │ │ Fetch  │   │ Context │       │
│              └────────────┘   └────────────┘ └─────────┘   └─────────┘       │
│                                       │                                    │
│                                       ▼                                    │
│                              ┌────────────────┐                              │
│                              │ Token Budget  │                              │
│                              │  Allocation   │                              │
│                              └────────────────┘                              │
│                                       │                                    │
│          ┌────────────────────────────┼────────────────────────────┐        │
│          │                            │                            │        │
│          ▼                            ▼                            ▼        │
│   ┌─────────────┐            ┌─────────────┐            ┌─────────────┐   │
│   │   Topic    │            │   Entity    │            │   Memory    │   │
│   │  Context   │            │  Context    │            │  Context    │   │
│   └─────────────┘            └─────────────┘            └─────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. Synchronization Flow

### 4.1 Client-Server Sync

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Client-Server Synchronization                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   PWA Client                                         Server                 │
│   ─────────                                         ──────                 │
│       │                                                │                    │
│       │  1. Local Change Detected                     │                    │
│       │       │                                        │                    │
│       │       ▼                                        │                    │
│       │  2. Create Sync Operation                     │                    │
│       │       │                                        │                    │
│       │       ▼                                        │                    │
│       │  3. Add to Sync Queue                         │                    │
│       │       │                                        │                    │
│       │       ▼                                        │                    │
│       ├──────────────────────────────────────────────► │                    │
│       │  4. Push Changes (REST/Socket)                │                    │
│       │                                                │                    │
│       │                                                ▼                    │
│       │                                        ┌─────────────┐              │
│       │                                        │  Validate   │              │
│       │                                        │  Operation  │              │
│       │                                        └──────┬──────┘              │
│       │                                               │                     │
│       │                                               ▼                     │
│       │                                        ┌─────────────┐              │
│       │                                        │   Apply to  │              │
│       │                                        │  Database   │              │
│       │                                        └──────┬──────┘              │
│       │                                               │                     │
│       │                                               ▼                     │
│       │                                        ┌─────────────┐              │
│       │                                        │  Broadcast  │              │
│       │                                        │   Changes   │              │
│       │                                        └──────┬──────┘              │
│       │                                               │                     │
│       ◄───────────────────────────────────────────────┤                     │
│       │  5. Sync Complete / Conflict Response        │                     │
│       │                                               │                     │
│       ▼                                               ▼                     │
│   ┌─────────────┐                              ┌─────────────┐             │
│   │  Update     │                              │  Broadcast  │             │
│   │  Local DB  │                              │  to Other   │             │
│   └─────────────┘                              │  Clients    │             │
│                                                 └─────────────┘             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 P2P Sync (Yjs CRDT)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     P2P CRDT Synchronization                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   Client A                        Network                      Client B      │
│   ────────                       ──────                      ────────      │
│       │                             │                            │            │
│       │  1. Local Change           │                            │            │
│       │     (User edits)           │                            │            │
│       │       │                     │                            │            │
│       │       ▼                     │                            │            │
│       │  2. Update Yjs Doc         │                            │            │
│       │       │                     │                            │            │
│       │       ▼                     │                            │            │
│       │  3. CRDT Merge             │                            │            │
│       │       │                     │                            │            │
│       │       ▼                     │                            │            │
│       ├────────────────────────────►│                            │            │
│       │  4. Sync Awareness         │                            │            │
│       │                             │                            │            │
│       │                             ├────────────────────────────►│            │
│       │                             │  5. Receive Update          │            │
│       │                             │                            │            │
│       │                             │                            ▼            │
│       │                             │                     ┌─────────────┐    │
│       │                             │                     │  Merge to   │    │
│       │                             │                     │  Local Doc  │    │
│       │                             │                     └──────┬──────┘    │
│       │                             │                            │            │
│       ◄─────────────────────────────┤                            │            │
│       │  6. Sync Response           │                            │            │
│       │                             │                            ▼            │
│       ▼                             │                     ┌─────────────┐    │
│   ┌─────────────┐                  │                     │  Conflict   │    │
│   │  UI Update  │                  │                     │  Resolved  │    │
│   └─────────────┘                  │                     └─────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. Social Flow

### 5.1 Follow System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Follow System Flow                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User A                                    User B                            │
│  ─────                                    ──────                            │
│    │                                         │                              │
│    │  1. Follow Request                     │                              │
│    │─────────────────────────────►           │                              │
│    │                                         │                              │
│    │                                         ▼                              │
│    │                                   ┌─────────────┐                     │
│    │                                   │  Validate   │                     │
│    │                                   │   Request   │                     │
│    │                                   └──────┬──────┘                     │
│    │                                          │                            │
│    │                                          ▼                            │
│    │                                   ┌─────────────┐                     │
│    │                                   │   Create    │                     │
│    │                                   │   Follow    │                     │
│    │                                   │   Record    │                     │
│    │                                   └──────┬──────┘                     │
│    │                                          │                            │
│    │                                          ▼                            │
│    │                                   ┌─────────────┐                     │
│    │                                   │   Update    │                     │
│    │                                   │  Follower   │                     │
│    │                                   │   Count     │                     │
│    │                                   └──────┬──────┘                     │
│    │                                          │                            │
│    │  2. Notification                        │                            │
│    │◄────────────────────────────────────────┘                            │
│    │
│    ▼
│  ┌─────────────┐
│  │  Update     │
│  │  Feed       │
│  └─────────────┘
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 Sharing Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Content Sharing Flow                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Content Owner                        Recipient                             │
│  ─────────────                        ─────────                             │
│    │                                      │                                 │
│    │  1. Create Share Intent             │                                 │
│    │       │                              │                                 │
│    │       ▼                              │                                 │
│    │  2. Define Permissions               │                                 │
│    │       │                              │                                 │
│    │       ▼                              │                                 │
│    │  3. Select Audience                 │                                 │
│    │       │                              │                                 │
│    │       ▼                              │                                 │
│    │  4. Create Access Grants            │                                 │
│    │       │                              │                                 │
│    │       ▼                              │                                 │
│    │  5. Generate Share Link (optional)   │                                 │
│    │       │                              │                                 │
│    │       ▼                              │                                 │
│    │                               ┌──────┴──────┐                          │
│    │                               │             │                          │
│    │                               ▼             ▼                          │
│    │                         ┌─────────┐   ┌─────────┐                   │
│    │                         │ Direct  │   │  Link   │                   │
│    │                         │  Grant  │   │  Access │                   │
│    │                         └────┬────┘   └────┬────┘                   │
│    │                              │             │                          │
│    │                              ▼             ▼                          │
│    │                         ┌─────────────────────────┐                    │
│    │                         │   Access Validation    │                    │
│    │                         │   + Content Retrieval  │                    │
│    │                         └────────────┬────────────┘                    │
│    │                                  │                                   │
│    │                                  ▼                                   │
│    │                              ┌─────────────┐                          │
│    │                              │   Log      │                          │
│    │                              │   Access   │                          │
│    │                              └─────────────┘                          │
│    │                                                                     │
│    └────────────────────────────────────────────────────────────────►     │
│    6. Access Logged                                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. Real-time Communication Flow

### 6.1 Socket.io Connection

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Socket.io Connection Flow                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Client                                                                  │
│  ──────                                                                  │
│    │                                                                       │
│    │  1. Initialize Socket.io Client                                       │
│    │       │                                                               │
│    │       ▼                                                               │
│    │  2. Connect to Server (with auth token)                               │
│    │       │                                                               │
│    │       ▼                                                               │
│    ├──────────────────────────────────────────────────────────────►        │
│    │  3. WebSocket Handshake                                              │
│    │                                                                       │
│    ◄───────────────────────────────────────────────────────────────┤        │
│    │  4. Connection Established (with socket ID)                       │
│    │                                                                       │
│    │                                                                       │
│    │  5. Join User Room                                                  │
│    │       │                                                               │
│    │       ▼                                                               │
│    ├──────────────────────────────────────────────────────────────►        │
│    │  6. Subscribe to Events                                            │
│    │                                                                       │
│    ◄───────────────────────────────────────────────────────────────┤        │
│    │  7. Ready for Real-time Communication                            │
│    │                                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 Presence System

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Presence System Flow                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Client A     ──►     Server     ◄───     Client B                        │
│  ───────              ──────              ───────                          │
│    │                     │                     │                           │
│    │ Heartbeat          │                     │                           │
│    │───────►           │                     │                           │
│    │                     │                     │                           │
│    │                     │  Broadcast          │                           │
│    │                     │───────►            │                           │
│    │                     │                     │                           │
│    │                     │                     │  Update Presence         │
│    │                     │                     │──────►                   │
│    │                     │                     │                           │
│    │                     │  Broadcast          │                           │
│    │◄───────────────────│───────             │                           │
│    │  Update Client B   │                     │                           │
│    │    Presence        │                     │                           │
│    │                     │                     │                           │
│    │                     │                     │  Disconnect               │
│    │                     │                     │───────►                   │
│    │                     │                     │                           │
│    │                     │  Broadcast          │                           │
│    │◄───────────────────│───────             │                           │
│    │  Client B Offline  │                     │                           │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. Search Flow

### 7.1 Unified Search

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Unified Search Flow                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  User Query ──► Parse Query ──► Route to Indices ──► Aggregate Results      │
│      │            │              │                  │                        │
│      │            ▼              ▼                  ▼                        │
│      │     ┌───────────┐   ┌───────────┐     ┌────────────┐              │
│      └─────►│  Query   │──►│  Search   │────►│   Rank &   │              │
│              │  Parser  │   │  Router   │     │   Merge    │              │
│              └───────────┘   └─────┬─────┘     └─────┬─────┘              │
│                                     │                  │                     │
│              ┌──────────────────────┼──────────────────┘                     │
│              │                      │                                        │
│              ▼                      ▼                                        │
│       ┌───────────┐          ┌───────────┐                                  │
│       │ Full-Text │          │ Semantic  │                                  │
│       │   Index   │          │   Index   │                                  │
│       └─────┬─────┘          └─────┬─────┘                                  │
│             │                      │                                         │
│             ▼                      ▼                                         │
│       ┌───────────┐          ┌───────────┐                                  │
│       │ Keyword   │          │  Vector   │                                  │
│       │  Match    │          │  Search   │                                  │
│       └───────────┘          └───────────┘                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. Error Handling Flow

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Error Handling Flow                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  Request ──► Validation ──► Processing ──► Response                         │
│    │            │              │              │                              │
│    │            ▼              │              │                              │
│    │      ┌─────────┐          │              │                              │
│    │      │  Valid  │          │              │                              │
│    │      │   No    │          │              │                              │
│    │      └───┬─────┘          │              │                              │
│    │          │                │              │                              │
│    │          ▼                │              │                              │
│    │    ┌──────────┐          │              │                              │
│    │    │  Error   │          │              │                              │
│    │    │ Response │          │              │                              │
│    │    └────┬─────┘          │              │                              │
│    │         │                │              │                              │
│    │         └────────────────┼──────────────┤                              │
│    │                          │              │                              │
│    │                          ▼              │                              │
│    │                    ┌──────────┐         │                              │
│    │                    │ Process  │         │                              │
│    │                    │ Request  │         │                              │
│    │                    └────┬─────┘         │                              │
│    │                         │               │                              │
│    │                         ▼               │                              │
│    │                   ┌──────────┐         │                              │
│    │                   │  Error   │─────────┴──────────────► Error        │
│    │                   │ Caught?  │              │         Response        │
│    │                   └────┬─────┘              │                          │
│    │                        │                    │                          │
│    │             ┌─────────┴─────────┐          │                          │
│    │             │                   │          │                          │
│    │             ▼                   ▼          ▼                          │
│    │       ┌──────────┐        ┌──────────┐ ┌──────────┐                  │
│    │       │  Handle  │        │  Global  │ │  Error   │                  │
│    │       │  Locally │        │  Handler │ │  Report  │                  │
│    │       └──────────┘        └────┬─────┘ └──────────┘                  │
│    │                                 │                                     │
│    └─────────────────────────────────┴──────────────► Response             │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

_Document Version: 1.0_
_Last Updated: February 2026_

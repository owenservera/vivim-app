// Prisma Schema for OpenScroll Capture API
// Database: PostgreSQL
// Runtime: Bun
// 
// Schema Design Philosophy:
// - Follows OpenAI ChatGPT export format standards
// - Compatible with LangChain message structure
// - Supports multimodal content (text, images, code, latex, etc.)
// - Normalized design with separate Messages table
// - JSONB for flexible content parts and metadata

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DATABASE_URL")

  // Security settings
  sslRequired = env("DATABASE_SSL_REQUIRED") == "true" ? true : false
}

// ============================================================================
// CONVERSATIONS TABLE
// Represents a complete conversation/chat session
// ============================================================================

model Conversation {
  id          String   @id @default(uuid())
  
  // Source Information
  provider    String   // "gemini", "chatgpt", "claude", etc.
  sourceUrl   String   @unique
  
  // Conversation Metadata
  title       String   @db.Text
  model       String?  // e.g., "gemini-2.0-flash", "gpt-4"
  
  // Timestamps from source
  createdAt   DateTime @db.Timestamptz  // When conversation was created
  updatedAt   DateTime @db.Timestamptz  // Last message time
  capturedAt  DateTime @default(now()) @db.Timestamptz // When we captured it
  
  // Statistics (computed from messages)
  messageCount      Int @default(0)
  userMessageCount  Int @default(0)
  aiMessageCount    Int @default(0)
  
  // Content Statistics
  totalWords        Int @default(0)
  totalCharacters   Int @default(0)
  totalTokens       Int? // If available from provider
  
  // Rich Content Counts
  totalCodeBlocks      Int @default(0)
  totalImages          Int @default(0)
  totalTables          Int @default(0)
  totalLatexBlocks     Int @default(0)
  totalMermaidDiagrams Int @default(0)
  totalToolCalls       Int @default(0)
  
  // Relationships
  messages    Message[]
  
  // Additional metadata (JSONB for flexibility)
  // Can store: tags, custom_instructions, temperature, etc.
  metadata    Json @default("{}")
  
  // Indexes for common queries
  @@index([provider])
  @@index([capturedAt(sort: Desc)])
  @@index([provider, capturedAt(sort: Desc)])
  @@index([sourceUrl])
  @@index([createdAt(sort: Desc)])
  @@map("conversations")
}

// ============================================================================
// MESSAGES TABLE
// Individual messages within a conversation
// Follows OpenAI/LangChain message structure
// ============================================================================

model Message {
  id              String   @id @default(uuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Message Core Fields
  role            String   // "user", "assistant", "system", "tool"
  author          String?  // Display name (e.g., "User", "ChatGPT", "Gemini")
  
  // Content stored as structured parts (JSONB array)
  // Each part has: { type, content, metadata }
  // Types: "text", "code", "image", "latex", "table", "mermaid", "tool_call", "tool_result"
  parts           Json     // Array of content parts
  
  // Timestamps
  createdAt       DateTime @db.Timestamptz
  
  // Position in conversation
  messageIndex    Int      // 0-based index in conversation
  
  // Status and Metadata
  status          String   @default("completed") // "completed", "error", "cancelled"
  finishReason    String?  // "stop", "length", "tool_calls", etc.
  
  // Token usage (if available)
  tokenCount      Int?
  
  // Additional metadata (JSONB)
  // Can store: model_slug, citations, feedback, edit_history, etc.
  metadata        Json @default("{}")
  
  // Indexes
  @@index([conversationId, messageIndex])
  @@index([conversationId, createdAt])
  @@index([role])
  @@map("messages")
}

// ============================================================================
// CONTENT PARTS STRUCTURE (stored in Message.parts JSONB)
// ============================================================================
// 
// Each part in the parts array follows this structure:
// 
// {
//   "type": "text" | "code" | "image" | "latex" | "table" | "mermaid" | "tool_call" | "tool_result",
//   "content": <string or object>,
//   "metadata": {
//     // Type-specific metadata
//   }
// }
//
// TEXT PART:
// {
//   "type": "text",
//   "content": "The actual text content...",
//   "metadata": {
//     "format": "markdown" | "plain"
//   }
// }
//
// CODE PART:
// {
//   "type": "code",
//   "content": "const x = 42;",
//   "metadata": {
//     "language": "javascript",
//     "filename": "example.js",
//     "highlighted": true
//   }
// }
//
// IMAGE PART:
// {
//   "type": "image",
//   "content": "https://...",  // URL or base64
//   "metadata": {
//     "alt": "Description",
//     "width": 800,
//     "height": 600,
//     "mimeType": "image/png",
//     "source": "generated" | "uploaded"
//   }
// }
//
// LATEX PART:
// {
//   "type": "latex",
//   "content": "f(x) = \\int_{-\\infty}^{\\infty} e^{-x^2} dx",
//   "metadata": {
//     "display": "block" | "inline"
//   }
// }
//
// TABLE PART:
// {
//   "type": "table",
//   "content": {
//     "headers": ["Col1", "Col2"],
//     "rows": [["A", "B"], ["C", "D"]]
//   },
//   "metadata": {
//     "format": "markdown" | "html"
//   }
// }
//
// MERMAID PART:
// {
//   "type": "mermaid",
//   "content": "graph TD\n  A-->B",
//   "metadata": {
//     "diagramType": "flowchart" | "sequence" | "gantt"
//   }
// }
//
// TOOL_CALL PART:
// {
//   "type": "tool_call",
//   "content": {
//     "id": "call_abc123",
//     "name": "web_search",
//     "arguments": { "query": "..." }
//   },
//   "metadata": {}
// }
//
// TOOL_RESULT PART:
// {
//   "type": "tool_result",
//   "content": {
//     "tool_call_id": "call_abc123",
//     "result": "..."
//   },
//   "metadata": {}
// }

// ============================================================================
// CAPTURE ATTEMPTS TABLE (for analytics/debugging/retry)
// ============================================================================

model CaptureAttempt {
  id          String   @id @default(uuid())
  sourceUrl   String
  provider    String?
  
  // Status tracking
  status      String   // "success", "failed", "timeout", "invalid_url"
  
  // Error details if failed
  errorCode   String?
  errorMessage String? @db.Text
  errorStack  String? @db.Text
  
  // Timing
  startedAt   DateTime @db.Timestamptz
  completedAt DateTime? @db.Timestamptz
  duration    Int?     // milliseconds
  
  // Request context
  ipAddress   String?
  userAgent   String?  @db.Text
  
  // Relation to conversation if successful
  conversationId String?
  
  // Retry information
  retryCount  Int @default(0)
  retryOf     String? // ID of original attempt if this is a retry
  
  // Timestamps
  createdAt   DateTime @default(now()) @db.Timestamptz
  
  // Indexes
  @@index([sourceUrl])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([ipAddress, createdAt(sort: Desc)])
  @@index([conversationId])
  @@map("capture_attempts")
}

// ============================================================================
// PROVIDER STATS TABLE (aggregated analytics)
// ============================================================================

model ProviderStats {
  id              String   @id @default(uuid())
  provider        String   @unique
  
  // Capture Counts
  totalCaptures      Int @default(0)
  successfulCaptures Int @default(0)
  failedCaptures     Int @default(0)
  
  // Performance Metrics
  avgDuration        Float? // milliseconds
  avgMessageCount    Float?
  avgTokenCount      Float?
  
  // Content Statistics
  totalMessages      Int @default(0)
  totalCodeBlocks    Int @default(0)
  totalImages        Int @default(0)
  totalToolCalls     Int @default(0)
  
  // Last updated
  lastCaptureAt   DateTime? @db.Timestamptz
  updatedAt       DateTime @updatedAt @db.Timestamptz
  
  @@map("provider_stats")
}

--- Starting Integration Tests ---

[1] Creating a test user...
[2026-02-22 20:20:47.603 +0100] [32mINFO[39m: [36mPrisma client initialized with enhanced observability[39m
prisma:query INSERT INTO "public"."users" ("id","did","email","emailVerified","phoneVerified","verificationLevel","verificationBadges","trustScore","publicKey","keyType","status","mfaEnabled","backupCodes","createdAt","updatedAt","lastSeenAt","settings","privacyPreferences") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,CAST($11::text AS "public"."AccountStatus"),$12,$13,$14,$15,$16,$17,$18) ON CONFLICT ("email") DO UPDATE SET "mfaEnabled" = $19, "mfaSecret" = $20, "backupCodes" = $21, "updatedAt" = $22 WHERE ("public"."users"."email" = $23 AND 1=1) RETURNING "public"."users"."id", "public"."users"."did", "public"."users"."handle", "public"."users"."displayName", "public"."users"."email", "public"."users"."emailVerified", "public"."users"."phoneNumber", "public"."users"."phoneVerified", "public"."users"."avatarUrl", "public"."users"."verificationLevel", "public"."users"."verificationBadges", "public"."users"."trustScore", "public"."users"."publicKey", "public"."users"."keyType", "public"."users"."status"::text, "public"."users"."deletedAt", "public"."users"."deletionRequestedAt", "public"."users"."suspendedAt", "public"."users"."suspensionReason", "public"."users"."bannedAt", "public"."users"."banReason", "public"."users"."mfaEnabled", "public"."users"."mfaSecret", "public"."users"."backupCodes", "public"."users"."pdsUrl", "public"."users"."createdAt", "public"."users"."updatedAt", "public"."users"."lastSeenAt", "public"."users"."settings", "public"."users"."privacyPreferences"
User created. ID: 37db06a8-4617-4c20-9549-04c7bb2dd2da

[2] Generating API key for user...
[2026-02-22 20:20:49.465 +0100] [33mWARN[39m: [36mSLOW_QUERY: upsert on User took 1840ms[39m
    [35mmodel[39m: "User"
    [35maction[39m: "upsert"
    [35mduration[39m: 1840
[2026-02-22 20:20:49.467 +0100] [33mWARN[39m: [36mPerformance issue reported[39m
    [35mmessage[39m: "Performance Issue: database_query_time"
    [35mvalue[39m: 1840
    [35mthreshold[39m: 100
    [35mcontext[39m: {
      "model": "User",
      "operation": "upsert",
      "query": {
        "where": {
          "email": "testmfa@example.com"
        },
        "update": {
          "mfaEnabled": false,
          "mfaSecret": null,
          "backupCodes": []
        },
        "create": {
          "email": "testmfa@example.com",
          "did": "did:key:zTest1771788047608",
          "publicKey": "mock-public-key",
          "trustScore": 100
        }
      }
    }
    [35mseverity[39m: "medium"
prisma:query INSERT INTO "public"."api_keys" ("id","userId","keyHash","name","expiresAt","createdAt") VALUES ($1,$2,$3,$4,$5,$6) RETURNING "public"."api_keys"."id", "public"."api_keys"."userId", "public"."api_keys"."keyHash", "public"."api_keys"."name", "public"."api_keys"."lastUsed", "public"."api_keys"."expiresAt", "public"."api_keys"."createdAt"
Generated Key: vk_live_c9Mqv_ZPQAeAVY1rEk_r_syctL5yU7qEgWn7sYtaCOk

[3] Testing GET /me/api-keys with generated key...
Î“Â£Ã  GET /me/api-keys successful. User has 4 keys.

[4] Testing POST /me/mfa/setup...
Î“Â£Ã  MFA Setup successful. Secret: BQOA2SDWOZGGK6JA

[5] Testing POST /me/mfa/enable...
Î“Â£Ã  MFA Enable successful. Received backup codes: [ "85bf452d", "ad3711fd", "b46311a2",
  "a819b594", "d05d0b37", "3db55458", "8cbd1f7a", "ac93baf5"
]

[6] Testing Conversations & Caching layer...
prisma:query SELECT "public"."conversations"."id", "public"."conversations"."provider", "public"."conversations"."sourceUrl", "public"."conversations"."contentHash", "public"."conversations"."version", "public"."conversations"."title", "public"."conversations"."model", "public"."conversations"."state", "public"."conversations"."createdAt", "public"."conversations"."updatedAt", "public"."conversations"."capturedAt", "public"."conversations"."messageCount", "public"."conversations"."userMessageCount", "public"."conversations"."aiMessageCount", "public"."conversations"."totalWords", "public"."conversations"."totalCharacters", "public"."conversations"."totalTokens", "public"."conversations"."totalCodeBlocks", "public"."conversations"."totalImages", "public"."conversations"."totalTables", "public"."conversations"."totalLatexBlocks", "public"."conversations"."totalMermaidDiagrams", "public"."conversations"."totalToolCalls", "public"."conversations"."metadata", "public"."conversations"."tags", "public"."conversations"."ownerId" FROM "public"."conversations" WHERE ("public"."conversations"."sourceUrl" = $1 AND 1=1) LIMIT $2 OFFSET $3
[2026-02-22 20:20:54.309 +0100] [33mWARN[39m: [36mRedis URL not configured. Using in-memory fallback.[39m
 9 | `))}toString(){return this.lines.join(`
10 | `)}};var Mu={red:we,gray:at,dim:nt,bold:Q,underline:it,highlightSource:e=>e.highlight()},_u={red:e=>e,gray:e=>e,dim:e=>e,bold:e=>e,underline:e=>e,highlightSource:e=>e};function Lu({message:e,originalMethod:t,isPanic:r,callArguments:n}){return{functionName:`prisma.${t}()`,message:e,isPanic:r??!1,callArguments:n}}function $u({callsite:e,message:t,originalMethod:r,isPanic:n,callArguments:i},o){let s=Lu({message:t,originalMethod:r,isPanic:n,callArguments:i});if(!e||typeof window<"u"||process.env.NODE_ENV==="production")return s;let a=e.getLocation();if(!a||!a.lineNumber||!a.columnNumber)return s;let l=Math.max(1,a.lineNumber-3),u=Yt.read(a.fileName)?.slice(l,a.lineNumber),c=u?.lineAt(a.lineNumber);if(u&&c){let p=qu(c),d=Vu(c);if(!d)return s;s.functionName=`${d.code})`,s.location=a,n||(u=u.mapLineAt(a.lineNumber,h=>h.slice(0,d.openingBraceIndex))),u=o.highlightSource(u);let f=String(u.lastLineNumber).length;if(s.contextLines=u.mapLines((h,x)=>o.gray(String(x).padStart(f))+" "+h).mapLines(h=>o.dim(h)).prependSymbol
11 | `)}function Uu(e){let t=[e.fileName];return e.lineNumber&&t.push(String(e.lineNumber)),e.columnNumber&&t.push(String(e.columnNumber)),t.join(":")}function Xt(e){let t=e.showColors?Mu:_u,r;return r=$u(e,t),ju(r,t)}var io=U(cn());function Xi(e,t,r){let n=eo(e),i=Bu(n),o=Ju(i);o?er(o,t,r):t.addErrorMessage(()=>"Unknown error")}function eo(e){return e.errors.flatMap(t=>t.kind==="Union"?eo(t):[t])}function Bu(e){let t=new Map,r=[];for(let n of e){if(n.kind!=="InvalidArgumentType"){r.push(n);continue}let i=`${n.selectionPath.join(".")}:${n.argumentPath.join(".")}`,o=t.get(i);o?t.set(i,{...n,argument:{...n.argument,typeNames:Qu(o.argument.typeNames,n.argument.typeNames)}}):t.set(i,n)}return r.push(...t.values()),r}function Qu(e,t){return[...new Set(e.concat(t))]}function Ju(e){return ln(e,(t,r)=>{let n=Zi(t),i=Zi(r);return n!==i?n-i:Yi(t)-Yi(r)})}function Zi(e){let t=0;return Array.isArray(e.selectionPath)&&(t+=e.selectionPath.length),Array.isArray(e.argumentPath)&&(t+=e.argumentPath.length),t}function Yi(e){switch(
12 | `)}getCurrentLineLength(){return this.currentLine.length}indentedCurrentLine(){let t=this.currentLine.padStart(this.currentLine.length+2*this.currentIndent);return this.marginSymbol?this.marginSymbol+t.slice(1):t}};to();var tr=class{constructor(t){this.value=t}write(t){t.write(this.value)}markAsError(){this.value.markAsError()}};var rr=e=>e,nr={bold:rr,red:rr,green:rr,dim:rr,enabled:!1},no={bold:Q,red:we,green:ot,dim:nt,enabled:!0},_e={write(e){e.writeLine(",")}};var W=class{constructor(t){this.contents=t}isUnderlined=!1;color=t=>t;underline(){return this.isUnderlined=!0,this}setColor(t){return this.color=t,this}write(t){let r=t.getCurrentLineLength();t.write(this.color(this.contents)),this.isUnderlined&&t.afterNextNewline(()=>{t.write(" ".repeat(r)).writeLine(this.color("~".repeat(this.contents.length)))})}};var ce=class{hasError=!1;markAsError(){return this.hasError=!0,this}};var Le=class extends ce{items=[];addItem(t){return this.items.push(new tr(t)),this}getField(t){return this.items[t]}getPrintWidth(){r
13 | Note that ${s.bold("include")} statements only accept relation fields.`,a})}function zu(e,t,r){let n=t.arguments.getDeepSubSelectionValue(e.selectionPath)?.asObject();if(n){let i=n.getField("omit")?.value.asObject();if(i){Wu(e,t,i);return}if(n.hasField("select")){Ku(e,t);return}}if(r?.[ue(e.outputType.name)]){Zu(e,t);return}t.addErrorMessage(()=>`Unknown field at "${e.selectionPath.join(".")} selection"`)}function Wu(e,t,r){r.removeAllFields();for(let n of e.outputType.fields)r.addSuggestion(new q(n.name,"false"));t.addErrorMessage(n=>`The ${n.red("omit")} statement includes every field of the model ${n.bold(e.outputType.name)}. At least one field must be included in the result`)}function Ku(e,t){let r=e.outputType,n=t.arguments.getDeepSelectionParent(e.selectionPath)?.value,i=n?.isEmpty()??!1;n&&(n.removeAllFields(),ao(n,r)),t.addErrorMessage(o=>i?`The ${o.red("`select`")} statement for type ${o.bold(r.name)} must not be empty. ${yt(o)}`:`The ${o.red("`select`")} statement for type ${o.bold(r.name)} needs ${
14 | `)}};function je(e){return new dn(mo(e))}function mo(e){let t=new $e;for(let[r,n]of Object.entries(e)){let i=new or(r,fo(n));t.addField(i)}return t}function fo(e){if(typeof e=="string")return new k(JSON.stringify(e));if(typeof e=="number"||typeof e=="boolean")return new k(String(e));if(typeof e=="bigint")return new k(`${e}n`);if(e===null)return new k("null");if(e===void 0)return new k("undefined");if(De(e))return new k(`new Prisma.Decimal("${e.toFixed()}")`);if(e instanceof Uint8Array)return Buffer.isBuffer(e)?new k(`Buffer.alloc(${e.byteLength})`):new k(`new Uint8Array(${e.byteLength})`);if(e instanceof Date){let t=Kt(e)?e.toISOString():"Invalid Date";return new k(`new Date("${t}")`)}return e instanceof po.ObjectEnumValue?new k(`Prisma.${e._getName()}`):qe(e)?new k(`prisma.${ue(e.modelName)}.$fields.${e.name}`):Array.isArray(e)?mc(e):typeof e=="object"?mo(e):new k(Object.prototype.toString.call(e))}function mc(e){let t=new Le;for(let r of e)t.addItem(fo(r));return t}function sr(e,t){let r=t==="pretty"?no:nr,

PrismaClientValidationError: 
Invalid `prisma.conversation.upsert()` invocation:

{
  where: {
    sourceUrl: "test://cache-test-1771788054311"
  },
  update: {
    provider: "openai",
    title: "Test Conversation Cache",
    model: undefined,
    createdAt: new Date("Invalid Date"),
               ~~~~~~~~~~~~~~~~~~~~~~~~
    updatedAt: new Date("2026-02-22T19:20:54.357Z"),
    capturedAt: new Date("2026-02-22T19:20:54.357Z"),
    contentHash: null,
    messageCount: 2,
    userMessageCount: 0,
    aiMessageCount: 0,
    totalWords: 0,
    totalCharacters: 0,
    totalTokens: null,
    totalCodeBlocks: 0,
    totalMermaidDiagrams: 0,
    totalImages: 0,
    totalTables: 0,
    totalLatexBlocks: 0,
    totalToolCalls: 0,
    metadata: {},
    version: {
      increment: 1
    }
  },
  create: {
    id: "dffaeb39-4e99-45ff-a6ee-ece3d77062f2",
    sourceUrl: "test://cache-test-1771788054311",
    provider: "openai",
    title: "Test Conversation Cache",
    model: undefined,
    createdAt: new Date("Invalid Date"),
    updatedAt: new Date("2026-02-22T19:20:54.357Z"),
    capturedAt: new Date("2026-02-22T19:20:54.357Z"),
    contentHash: null,
    messageCount: 2,
    userMessageCount: 0,
    aiMessageCount: 0,
    totalWords: 0,
    totalCharacters: 0,
    totalTokens: null,
    totalCodeBlocks: 0,
    totalMermaidDiagrams: 0,
    totalImages: 0,
    totalTables: 0,
    totalLatexBlocks: 0,
    totalToolCalls: 0,
    metadata: {},
    version: 1
  },
  include: {
    messages: {
      select: {
        id: true,
        messageIndex: true
      }
    }
  }
}

Invalid value for argument `createdAt`: Provided Date object is invalid. Expected Date.
 clientVersion: "7.4.0",

      at ar (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:14:1386)
      at throwValidationError (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at So (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at Ao (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at Ao (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at bt (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at pr (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:356)
      at _executeRequest (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:2759)
      at o (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:2589)
      at then (C:\0-BlackBoxProject-0\vivim-app\server\node_modules\.prisma\client\runtime\client.js:5:2589)

[2026-02-22 20:20:54.391 +0100] [31mERROR[39m: [36mDB_FAILURE [upsert on Conversation]: Database operation failed: upsert on Conversation (
Invalid `prisma.conversation.upsert()` invocation:

{
  where: {
    sourceUrl: "test://cache-test-1771788054311"
  },
  update: {
    provider: "openai",
    title: "Test Conversation Cache",
    model: undefined,
    createdAt: new Date("Invalid Date"),
               ~~~~~~~~~~~~~~~~~~~~~~~~
    updatedAt: new Date("2026-02-22T19:20:54.357Z"),
    capturedAt: new Date("2026-02-22T19:20:54.357Z"),
    contentHash: null,
    messageCount: 2,
    userMessageCount: 0,
    aiMessageCount: 0,
    totalWords: 0,
    totalCharacters: 0,
    totalTokens: null,
    totalCodeBlocks: 0,
    totalMermaidDiagrams: 0,
    totalImages: 0,
    totalTables: 0,
    totalLatexBlocks: 0,
    totalToolCalls: 0,
    metadata: {},
    version: {
      increment: 1
    }
  },
  create: {
    id: "dffaeb39-4e99-45ff-a6ee-ece3d77062f2",
    sourceUrl: "test://cache-test-1771788054311",
    provider: "openai",
    title: "Test Conversation Cache",
    model: undefined,
    createdAt: new Date("Invalid Date"),
    updatedAt: new Date("2026-02-22T19:20:54.357Z"),
    capturedAt: new Date("2026-02-22T19:20:54.357Z"),
    contentHash: null,
    messageCount: 2,
    userMessageCount: 0,
    aiMessageCount: 0,
    totalWords: 0,
    totalCharacters: 0,
    totalTokens: null,
    totalCodeBlocks: 0,
    totalMermaidDiagrams: 0,
    totalImages: 0,
    totalTables: 0,
    totalLatexBlocks: 0,
    totalToolCalls: 0,
    metadata: {},
    version: 1
  },
  include: {
    messages: {
      select: {
        id: true,
        messageIndex: true
      }
    }
  }
}

Invalid value for argument `createdAt`: Provided Date object is invalid. Expected Date.)[39m
    [35mduration[39m: "26ms"
    [35mcontext[39m: {
      "model": "Conversation",
      "operation": "upsert",
      "args": {
        "where": {
          "sourceUrl": "test://cache-test-1771788054311"
        },
        "update": {
          "provider": "openai",
          "title": "Test Conversation Cache",
          "createdAt": null,
          "updatedAt": "2026-02-22T19:20:54.357Z",
          "capturedAt": "2026-02-22T19:20:54.357Z",
          "contentHash": null,
          "messageCount": 2,
          "userMessageCount": 0,
          "aiMessageCount": 0,
          "totalWords": 0,
          "totalCharacters": 0,
          "totalTokens": null,
          "totalCodeBlocks": 0,
          "totalMermaidDiagrams": 0,
          "totalImages": 0,
          "totalTables": 0,
          "totalLatexBlocks": 0,
          "totalToolCalls": 0,
          "metadata": {},
          "version": {
            "increment": 1
          }
        },
        "create": {
          "id": "dffaeb39-4e99-45ff-a6ee-ece3d77062f2",
          "sourceUrl": "test://cache-test-1771788054311",
          "provider": "openai",
          "title": "Test Conversation Cache",
          "createdAt": null,
          "updatedAt": "2026-02-22T19:20:54.357Z",
          "capturedAt": "2026-02-22T19:20:54.357Z",
          "contentHash": null,
          "messageCount": 2,
          "userMessageCount": 0,
          "aiMessageCount": 0,
          "totalWords": 0,
          "totalCharacters": 0,
          "totalTokens": null,
          "totalCodeBlocks": 0,
          "totalMermaidDiagrams": 0,
          "totalImages": 0,
          "totalTables": 0,
          "totalLatexBlocks": 0,
          "totalToolCalls": 0,
          "metadata": {},
          "version": 1
        },
        "include": {
          "messages": {
            "select": {
              "id": true,
              "messageIndex": true
            }
          }
        }
      },
      "duration": 26
    }
    [35mseverity[39m: "critical"
[2026-02-22 20:20:54.394 +0100] [31mERROR[39m: [36mFailed to save conversation to DB[39m
    error: "\nInvalid `prisma.conversation.upsert()` invocation:\n\n{\n  where: {\n    sourceUrl: \"test://cache-test-1771788054311\"\n  },\n  update: {\n    provider: \"openai\",\n    title: \"Test Conversation Cache\",\n    model: undefined,\n    createdAt: new Date(\"Invalid Date\"),\n               ~~~~~~~~~~~~~~~~~~~~~~~~\n    updatedAt: new Date(\"2026-02-22T19:20:54.357Z\"),\n    capturedAt: new Date(\"2026-02-22T19:20:54.357Z\"),\n    contentHash: null,\n    messageCount: 2,\n    userMessageCount: 0,\n    aiMessageCount: 0,\n    totalWords: 0,\n    totalCharacters: 0,\n    totalTokens: null,\n    totalCodeBlocks: 0,\n    totalMermaidDiagrams: 0,\n    totalImages: 0,\n    totalTables: 0,\n    totalLatexBlocks: 0,\n    totalToolCalls: 0,\n    metadata: {},\n    version: {\n      increment: 1\n    }\n  },\n  create: {\n    id: \"dffaeb39-4e99-45ff-a6ee-ece3d77062f2\",\n    sourceUrl: \"test://cache-test-1771788054311\",\n    provider: \"openai\",\n    title: \"Test Conversation Cache\",\n    model: undefined,\n    createdAt: new Date(\"Invalid Date\"),\n    updatedAt: new Date(\"2026-02-22T19:20:54.357Z\"),\n    capturedAt: new Date(\"2026-02-22T19:20:54.357Z\"),\n    contentHash: null,\n    messageCount: 2,\n    userMessageCount: 0,\n    aiMessageCount: 0,\n    totalWords: 0,\n    totalCharacters: 0,\n    totalTokens: null,\n    totalCodeBlocks: 0,\n    totalMermaidDiagrams: 0,\n    totalImages: 0,\n    totalTables: 0,\n    totalLatexBlocks: 0,\n    totalToolCalls: 0,\n    metadata: {},\n    version: 1\n  },\n  include: {\n    messages: {\n      select: {\n        id: true,\n        messageIndex: true\n      }\n    }\n  }\n}\n\nInvalid value for argument `createdAt`: Provided Date object is invalid. Expected Date."

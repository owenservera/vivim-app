--- Starting Integration Tests ---

[1] Creating a test user...
[2026-02-22 20:30:50.846 +0100] [32mINFO[39m: [36mPrisma client initialized with enhanced observability[39m
prisma:query INSERT INTO "public"."users" ("id","did","email","emailVerified","phoneVerified","verificationLevel","verificationBadges","trustScore","publicKey","keyType","status","mfaEnabled","backupCodes","createdAt","updatedAt","lastSeenAt","settings","privacyPreferences") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,CAST($11::text AS "public"."AccountStatus"),$12,$13,$14,$15,$16,$17,$18) ON CONFLICT ("email") DO UPDATE SET "mfaEnabled" = $19, "mfaSecret" = $20, "backupCodes" = $21, "updatedAt" = $22 WHERE ("public"."users"."email" = $23 AND 1=1) RETURNING "public"."users"."id", "public"."users"."did", "public"."users"."handle", "public"."users"."displayName", "public"."users"."email", "public"."users"."emailVerified", "public"."users"."phoneNumber", "public"."users"."phoneVerified", "public"."users"."avatarUrl", "public"."users"."verificationLevel", "public"."users"."verificationBadges", "public"."users"."trustScore", "public"."users"."publicKey", "public"."users"."keyType", "public"."users"."status"::text, "public"."users"."deletedAt", "public"."users"."deletionRequestedAt", "public"."users"."suspendedAt", "public"."users"."suspensionReason", "public"."users"."bannedAt", "public"."users"."banReason", "public"."users"."mfaEnabled", "public"."users"."mfaSecret", "public"."users"."backupCodes", "public"."users"."pdsUrl", "public"."users"."createdAt", "public"."users"."updatedAt", "public"."users"."lastSeenAt", "public"."users"."settings", "public"."users"."privacyPreferences"
User created. ID: d1dfc450-a5a9-4f00-b17a-098dbe373ff2

[2] Generating API key for user...
[2026-02-22 20:30:51.218 +0100] [33mWARN[39m: [36mSLOW_QUERY: upsert on User took 364ms[39m
    [35mmodel[39m: "User"
    [35maction[39m: "upsert"
    [35mduration[39m: 364
[2026-02-22 20:30:51.219 +0100] [33mWARN[39m: [36mPerformance issue reported[39m
    [35mmessage[39m: "Performance Issue: database_query_time"
    [35mvalue[39m: 364
    [35mthreshold[39m: 100
    [35mcontext[39m: {
      "model": "User",
      "operation": "upsert",
      "query": {
        "where": {
          "email": "testmfa@example.com"
        },
        "update": {
          "mfaEnabled": false,
          "mfaSecret": null,
          "backupCodes": []
        },
        "create": {
          "email": "testmfa@example.com",
          "did": "did:key:zTest1771788650849",
          "publicKey": "mock-public-key",
          "trustScore": 100
        }
      }
    }
    [35mseverity[39m: "low"
prisma:query INSERT INTO "public"."api_keys" ("id","userId","keyHash","name","expiresAt","createdAt") VALUES ($1,$2,$3,$4,$5,$6) RETURNING "public"."api_keys"."id", "public"."api_keys"."userId", "public"."api_keys"."keyHash", "public"."api_keys"."name", "public"."api_keys"."lastUsed", "public"."api_keys"."expiresAt", "public"."api_keys"."createdAt"
Generated Key: vk_live_S5FOsrT5LDi_-CXK-JtmSw0yG7vvKq4xGrnhG2NTbjo

[3] Testing GET /me/api-keys with generated key...
Î“Â£Ã  GET /me/api-keys successful. User has 1 keys.

[4] Testing POST /me/mfa/setup...
Î“Â£Ã  MFA Setup successful. Secret: IU2AYNJUJ5FBKABA

[5] Testing POST /me/mfa/enable...
Î“Â£Ã  MFA Enable successful. Received backup codes: [ "01286a38", "fb119225", "5af56753",
  "0fbdaf88", "295eb812", "b82f51f3", "33ac74e8", "58007b00"
]

[6] Testing Conversations & Caching layer...
[2026-02-22 20:30:51.729 +0100] [33mWARN[39m: [36mRedis URL not configured. Using in-memory fallback.[39m
prisma:query SELECT "public"."conversations"."id", "public"."conversations"."provider", "public"."conversations"."sourceUrl", "public"."conversations"."contentHash", "public"."conversations"."version", "public"."conversations"."title", "public"."conversations"."model", "public"."conversations"."state", "public"."conversations"."createdAt", "public"."conversations"."updatedAt", "public"."conversations"."capturedAt", "public"."conversations"."messageCount", "public"."conversations"."userMessageCount", "public"."conversations"."aiMessageCount", "public"."conversations"."totalWords", "public"."conversations"."totalCharacters", "public"."conversations"."totalTokens", "public"."conversations"."totalCodeBlocks", "public"."conversations"."totalImages", "public"."conversations"."totalTables", "public"."conversations"."totalLatexBlocks", "public"."conversations"."totalMermaidDiagrams", "public"."conversations"."totalToolCalls", "public"."conversations"."metadata", "public"."conversations"."tags", "public"."conversations"."ownerId" FROM "public"."conversations" WHERE ("public"."conversations"."sourceUrl" = $1 AND 1=1) LIMIT $2 OFFSET $3
prisma:query SELECT "public"."conversations"."id" FROM "public"."conversations" WHERE ("public"."conversations"."sourceUrl" = $1 AND 1=1) OFFSET $2
prisma:query INSERT INTO "public"."conversations" ("id","provider","sourceUrl","contentHash","version","title","state","createdAt","updatedAt","capturedAt","messageCount","userMessageCount","aiMessageCount","totalWords","totalCharacters","totalTokens","totalCodeBlocks","totalImages","totalTables","totalLatexBlocks","totalMermaidDiagrams","totalToolCalls","metadata") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11,$12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22,$23) RETURNING "public"."conversations"."id"
prisma:query SELECT "public"."conversations"."id", "public"."conversations"."provider", "public"."conversations"."sourceUrl", "public"."conversations"."contentHash", "public"."conversations"."version", "public"."conversations"."title", "public"."conversations"."model", "public"."conversations"."state", "public"."conversations"."createdAt", "public"."conversations"."updatedAt", "public"."conversations"."capturedAt", "public"."conversations"."messageCount", "public"."conversations"."userMessageCount", "public"."conversations"."aiMessageCount", "public"."conversations"."totalWords", "public"."conversations"."totalCharacters", "public"."conversations"."totalTokens", "public"."conversations"."totalCodeBlocks", "public"."conversations"."totalImages", "public"."conversations"."totalTables", "public"."conversations"."totalLatexBlocks", "public"."conversations"."totalMermaidDiagrams", "public"."conversations"."totalToolCalls", "public"."conversations"."metadata", "public"."conversations"."tags", "public"."conversations"."ownerId" FROM "public"."conversations" WHERE "public"."conversations"."id" = $1 LIMIT $2 OFFSET $3
prisma:query SELECT "public"."messages"."id", "public"."messages"."messageIndex", "public"."messages"."conversationId" FROM "public"."messages" WHERE "public"."messages"."conversationId" = $1 OFFSET $2
prisma:query COMMIT
[2026-02-22 20:30:51.801 +0100] [32mINFO[39m: [36mCreating new messages for conversation[39m
    [35mconversationId[39m: "59bcabf1-8b7f-4604-a5c5-aefc5321d6ca"
    [35mcount[39m: 2
prisma:query INSERT INTO "public"."messages" ("id","conversationId","role","author","parts","contentHash","version","createdAt","messageIndex","status","metadata") VALUES ($1,$2,$3,$4,$5,$6,$7,$8,$9,$10,$11), ($12,$13,$14,$15,$16,$17,$18,$19,$20,$21,$22)
prisma:query COMMIT
Î“Â£Ã  Conversation created with ID: 59bcabf1-8b7f-4604-a5c5-aefc5321d6ca and 0 messages

Fetching messages for 59bcabf1-8b7f-4604-a5c5-aefc5321d6ca... (Cache miss expected)
First fetch returned undefined messages.
Fetching messages AGAIN for 59bcabf1-8b7f-4604-a5c5-aefc5321d6ca... (Cache hit expected)
Second fetch returned undefined messages.

[7] Cleaning up test data...
prisma:query DELETE FROM "public"."users" WHERE ("public"."users"."id" = $1 AND 1=1) RETURNING "public"."users"."id", "public"."users"."did", "public"."users"."handle", "public"."users"."displayName", "public"."users"."email", "public"."users"."emailVerified", "public"."users"."phoneNumber", "public"."users"."phoneVerified", "public"."users"."avatarUrl", "public"."users"."verificationLevel", "public"."users"."verificationBadges", "public"."users"."trustScore", "public"."users"."publicKey", "public"."users"."keyType", "public"."users"."status"::text, "public"."users"."deletedAt", "public"."users"."deletionRequestedAt", "public"."users"."suspendedAt", "public"."users"."suspensionReason", "public"."users"."bannedAt", "public"."users"."banReason", "public"."users"."mfaEnabled", "public"."users"."mfaSecret", "public"."users"."backupCodes", "public"."users"."pdsUrl", "public"."users"."createdAt", "public"."users"."updatedAt", "public"."users"."lastSeenAt", "public"."users"."settings", "public"."users"."privacyPreferences"
Î“Â£Ã  User testmfa@example.com deleted.

--- Integration Tests Complete ---
[2026-02-22 20:30:51.966 +0100] [33mWARN[39m: [36mSLOW_QUERY: delete on User took 139ms[39m
    [35mmodel[39m: "User"
    [35maction[39m: "delete"
    [35mduration[39m: 139
[2026-02-22 20:30:51.967 +0100] [33mWARN[39m: [36mPerformance issue reported[39m
    [35mmessage[39m: "Performance Issue: database_query_time"
    [35mvalue[39m: 139
    [35mthreshold[39m: 100
    [35mcontext[39m: {
      "model": "User",
      "operation": "delete",
      "query": {
        "where": {
          "id": "d1dfc450-a5a9-4f00-b17a-098dbe373ff2"
        }
      }
    }
    [35mseverity[39m: "low"
